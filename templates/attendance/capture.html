<!DOCTYPE html>
<html>
<head>
    <title>Davomat - Kamera</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .camera-container {
            margin: 20px auto;
            position: relative;
            display: inline-block;
        }
        #video {
            border: 3px solid #333;
            border-radius: 10px;
            max-width: 100%;
            background: #000;
            width: 640px;
            height: 480px;
        }
        #canvas {
            display: none;
        }
        .controls {
            margin: 20px;
        }
        button {
            padding: 12px 24px;
            margin: 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .btn-start {
            background: #28a745;
            color: white;
        }
        .btn-capture {
            background: #007bff;
            color: white;
        }
        .btn-restart {
            background: #ffc107;
            color: black;
        }
        .btn-stop {
            background: #dc3545;
            color: white;
        }
        button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        .status {
            padding: 12px;
            margin: 15px;
            border-radius: 6px;
            font-weight: bold;
        }
        .status-active {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        #result {
            margin: 20px;
            padding: 15px;
            border-radius: 6px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        .nav-links {
            margin: 20px 0;
        }
        .nav-links a {
            margin: 0 10px;
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé• Real-time Davomat</h1>

        <div class="nav-links">
            <a href="/">üè† Bosh Sahifa</a>
            <a href="/enroll/">üë§ Xodim Qo'shish</a>
            <a href="/report/">üìä Hisobot</a>
        </div>

        <div class="camera-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
        </div>

        <div class="controls">
            <button id="startBtn" class="btn-start">üé¨ Kamerni Yoqish</button>
            <button id="captureBtn" class="btn-capture">üì∏ Davomat Qilish</button>
            <button id="restartBtn" class="btn-restart">üîÑ Qayta Ishga Tushirish</button>
            <button id="stopBtn" class="btn-stop">‚èπÔ∏è To'xtatish</button>
        </div>

        <div id="status" class="status status-inactive">
            üî¥ Kamera faol emas - "Kamerni Yoqish" tugmasini bosing
        </div>

        <div id="result">
            Bu yerda davomat natijalari ko'rinadi
        </div>
    </div>

    <script>
        // ========== CAPTURE.HTML UCHUN JAVASCRIPT KODI ==========
        let video = null;
        let canvas = null;
        let context = null;
        let stream = null;
        let isCameraActive = false;

        // üé• Kamerani ishga tushurish
        function startWebcam() {
            console.log("üîç startWebcam() funksiyasi chaqirildi");

            video = document.getElementById("video");
            canvas = document.getElementById("canvas");

            if (!video || !canvas) {
                alert("Video yoki canvas elementi topilmadi.");
                return;
            }

            context = canvas.getContext("2d");

            if (!navigator.mediaDevices?.getUserMedia) {
                alert("Brauzeringiz kamera funksiyasini qo ªllab-quvvatlamaydi.");
                return;
            }

            if (stream) {
                stopWebcam();
            }

            navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: "user",
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                },
                audio: false
            })
            .then((mediaStream) => {
                console.log("‚úÖ Kamera ruhsat berildi");
                stream = mediaStream;
                video.srcObject = mediaStream;
                isCameraActive = true;

                video.onloadedmetadata = () => {
                    console.log("‚úÖ Kamera ishga tushdi");
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    updateStatus();
                };

            })
            .catch((err) => {
                console.error("‚ùå Camera error:", err);
                isCameraActive = false;
                updateStatus();

                let errorMessage = "Kamera ochishda xatolik: ";
                if (err.name === 'NotAllowedError') {
                    errorMessage += "Kamera ruxsati berilmagan.";
                } else if (err.name === 'NotFoundError') {
                    errorMessage += "Kamera topilmadi.";
                } else {
                    errorMessage += err.message;
                }
                alert(errorMessage);
            });
        }

        // üñºÔ∏è Suratni olish
        function captureToBase64() {
            if (!isCameraActive || !video) {
                alert("Kamera faol emas.");
                return null;
            }

            try {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                const imageData = canvas.toDataURL("image/jpeg", 0.8);
                console.log("üì∏ Surat olindi");
                return imageData;

            } catch (err) {
                console.error("‚ùå Surat olishda xatolik:", err);
                alert("Suratni olishda xatolik");
                return null;
            }
        }

        // üì§ Davomat qilish
        async function captureAndSend() {
            console.log("üéØ Davomat qilinmoqda...");

            if (!isCameraActive) {
                alert("Iltimos, avval kamerni yoqing.");
                return;
            }

            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>‚è≥ Surat olinmoqda...</p>';

            const imageData = captureToBase64();
            if (!imageData) return;

            resultDiv.innerHTML = '<p>‚è≥ Yuzni tanish jarayonda...</p>';

            try {
                const response = await fetch('/process_attendance/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `image=${encodeURIComponent(imageData)}`
                });

                const data = await response.json();
                console.log("üìä Server javobi:", data);

                if (data.status === 'success') {
                    resultDiv.innerHTML = `
                        <div style="color: green; font-weight: bold;">
                            ‚úÖ ${data.action} - ${data.employee_name}
                        </div>
                        <div style="font-size: 14px;">
                            Masofa: ${data.distance} | Vaqt: ${data.processing_time}s
                        </div>
                    `;
                } else if (data.status === 'no_match') {
                    resultDiv.innerHTML = `
                        <div style="color: orange; font-weight: bold;">
                            ‚ùå ${data.message}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div style="color: red; font-weight: bold;">
                            ‚ùå ${data.message}
                        </div>
                    `;
                }

            } catch (error) {
                console.error('‚ùå Server xatosi:', error);
                resultDiv.innerHTML = '<div style="color: red;">‚ùå Server xatosi</div>';
            }
        }

        // üõë Kamerani to'xtatish
        function stopWebcam() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            if (video) {
                video.srcObject = null;
            }
            isCameraActive = false;
            updateStatus();
            console.log("üõë Kamera to'xtatildi");
        }

        // üîÑ Qayta ishga tushirish
        function restartWebcam() {
            stopWebcam();
            setTimeout(startWebcam, 500);
        }

        // üìä Status yangilash
        function updateStatus() {
            const statusDiv = document.getElementById('status');
            if (statusDiv) {
                if (isCameraActive) {
                    statusDiv.innerHTML = 'üü¢ Kamera faol - Davomat qilish uchun tugmani bosing';
                    statusDiv.className = 'status status-active';
                } else {
                    statusDiv.innerHTML = 'üî¥ Kamera faol emas';
                    statusDiv.className = 'status status-inactive';
                }
            }
        }

        // Tugmalarni bog'lash
        document.getElementById('startBtn').addEventListener('click', startWebcam);
        document.getElementById('captureBtn').addEventListener('click', captureAndSend);
        document.getElementById('restartBtn').addEventListener('click', restartWebcam);
        document.getElementById('stopBtn').addEventListener('click', stopWebcam);

        // Sahifa yuklanganda
        document.addEventListener('DOMContentLoaded', function() {
            console.log("‚úÖ Capture sahifasi yuklandi");
        });

        // Status yangilash
        setInterval(updateStatus, 3000);
    </script>
</body>
</html>